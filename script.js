const characters = {
    "Tokyo Jujutsu High": [
        {name: "Kiyotaka Ijichi", image: "images/Tokyo Jujutsu High/Kiyotaka Ijichi.PNG"},
        {name: "Atsuya Kusakabe", image: "images/Tokyo Jujutsu High/Atsuya Kusakabe.PNG"},
        {name: "Akari Nitta", image: "images/Tokyo Jujutsu High/Akari Nitta.PNG"},
        {name: "Kento Nanami", image: "images/Tokyo Jujutsu High/Kento Nanami.PNG"},
        {name: "Maki Zenin", image: "images/Tokyo Jujutsu High/Maki Zenin.PNG"},
        {name: "Masamichi Yaga", image: "images/Tokyo Jujutsu High/Masamichi Yaga.PNG"},
        {name: "Megumi Fushiguro", image: "images/Tokyo Jujutsu High/Megumi Fushiguro.PNG"},
        {name: "Mei Mei", image: "images/Tokyo Jujutsu High/Mei Mei.PNG"},
        {name: "Nobara Kugisaki", image: "images/Tokyo Jujutsu High/Nobara Kugisaki.PNG"},
        {name: "Panda", image: "images/Tokyo Jujutsu High/Panda.PNG"},
        {name: "Satoru Gojo", image: "images/Tokyo Jujutsu High/Satoru Gojo.PNG"},
        {name: "Shoko Ieiri", image: "images/Tokyo Jujutsu High/Shoko Ieiri.PNG"},
        {name: "Suguru Geto", image: "images/Tokyo Jujutsu High/Suguru Geto.PNG"},
        {name: "Toge Inumaki", image: "images/Tokyo Jujutsu High/Toge Inumaki.PNG"},
        {name: "Yuji Itadori", image: "images/Tokyo Jujutsu High/Yuji Itadori.PNG"},
        {name: "Takuma Ino", image: "images/Tokyo Jujutsu High/Takuma Ino.PNG"},
        {name: "Yu Haibara", image: "images/Tokyo Jujutsu High/Yu Haibara.PNG"},
        {name: "Yuki Tsukumo", image: "images/Tokyo Jujutsu High/Yuki Tsukumo.PNG"},
        {name: "Yuta Okkotsu", image: "images/Tokyo Jujutsu High/Yuta Okkotsu.PNG"},
    ],
    "Curses": [
        {name: "Hanami", image: "images/Curses/Hanami.PNG"},
        {name: "Mahito", image: "images/Curses/Mahito.PNG"},
        {name: "Jogo", image: "images/Curses/Jogo.PNG"},
        {name: "Eso", image: "images/Curses/Eso.PNG"},
        {name: "Dagon", image: "images/Curses/Dagon.PNG"},
        {name: "Kechizu", image: "images/Curses/Kechizu.PNG"},
        {name: "Rika", image: "images/Curses/Rika.PNG"},
        {name: "Kenjaku", image: "images/Curses/Kenjaku.PNG"},
        {name: "Choso Kamo", image: "images/Curses/Choso Kamo.PNG"},        
    ],    
    "Civilians": [
        {name: "Fumi", image: "images/Civilians/Fumi.PNG"},
        {name: "Nagi Yoshino", image: "images/Civilians/Nagi Yoshino.PNG"},
        {name: "Saori", image: "images/Civilians/Saori.PNG"},
        {name: "Tsumiki Fushiguro", image: "images/Civilians/Tsumiki Fushiguro.PNG"},
        {name: "Wasuke Itadori", image: "images/Civilians/Wasuke Itadori.PNG"},
        {name: "Yuko Ozawa", image: "images/Civilians/Yuko Ozawa.PNG"},
    ],    
    "Kyoto Jujutsu High": [
        {name: "Aoi Todo", image: "images/Kyoto Jujutsu High/Aoi Todo.PNG"},
        {name: "Arata Nitta", image: "images/Kyoto Jujutsu High/Arata Nitta.PNG"},
        {name: "Kasumi Miwa", image: "images/Kyoto Jujutsu High/Kasumi Miwa.PNG"},
        {name: "Kokichi Muta", image: "images/Kyoto Jujutsu High/Kokichi Muta.PNG"},
        {name: "Mai Zenin", image: "images/Kyoto Jujutsu High/Mai Zenin.PNG"},
        {name: "Momo Nishimiya", image: "images/Kyoto Jujutsu High/Momo Nishimiya.PNG"},
        {name: "Noritoshi Kamo", image: "images/Kyoto Jujutsu High/Noritoshi Kamo.PNG"},
        {name: "Utahime Iori", image: "images/Kyoto Jujutsu High/Utahime Iori.PNG"},
        {name: "Yoshinobu Gakuganji", image: "images/Kyoto Jujutsu High/Yoshinobu Gakuganji.PNG"},
    ], 
    "Sorcerers.users": [ // Исправлено: имя свойства в кавычках
        {name: "Haruta Shigemo", image: "images/Sorcerers.users/Haruta Shigemo.PNG"},
        {name: "Jiro Awasaka", image: "images/Sorcerers.users/Jiro Awasaka.PNG"},
        {name: "Junpei Yoshino", image: "images/Sorcerers.users/Junpei Yoshino.PNG"},
        {name: "Juzo Kumiya", image: "images/Sorcerers.users/Juzo Kumiya.PNG"},
        {name: "Larue", image: "images/Sorcerers.users/Larue.PNG"},
        {name: "Manami Suda", image: "images/Sorcerers.users/Manami Suda.PNG"},
        {name: "Miguel", image: "images/Sorcerers.users/Miguel.PNG"},
        {name: "Mimiko Hasaba", image: "images/Sorcerers.users/Mimiko Hasaba.PNG"},
        {name: "Misato Kuroi", image: "images/Sorcerers.users/Misato Kuroi.PNG"},
        {name: "Nanako Hasaba", image: "images/Sorcerers.users/Nanako Hasaba.PNG"},
        {name: "Naobito Zenin", image: "images/Sorcerers.users/Naobito Zenin.PNG"},
        {name: "Ogami", image: "images/Sorcerers.users/Ogami.PNG"},
        {name: "Riko Amanai", image: "images/Sorcerers.users/Riko Amanai.PNG"},
        {name: "Toji Fushiguro", image: "images/Sorcerers.users/Toji Fushiguro.PNG"},
        {name: "Toshihisa Negi", image: "images/Sorcerers.users/Toshihisa Negi.PNG"},
        {name: "Ui Ui", image: "images/Sorcerers.users/Ui Ui.PNG"},
        {name: "Uraume", image: "images/Sorcerers.users/Uraume.PNG"},
    ],
};

let selectedCharacters = [];
let comparisons = [];
let results = {};
let transitiveWeights = {}; 
let currentLeftChar = null;
let currentRightChar = null;

document.getElementById('start-btn').addEventListener('click', startSorting);

function startSorting() {
    console.log("Функция startSorting вызвана");
    
    const selectedGroups = Array.from(document.querySelectorAll('.group-select:checked')).map(el => el.value);
    console.log("Выбранные группы:", selectedGroups);

    if (selectedGroups.length === 0) {
        alert("Пожалуйста, выберите хотя бы одну группу!");
        return;
    }
    
    selectedCharacters = [];
    selectedGroups.forEach(group => {
        if (characters[group]) {
            selectedCharacters = selectedCharacters.concat(characters[group]);
        } else {
            console.warn(`Группа "${group}" не найдена в списке персонажей`);
        }
    });
    
    if (selectedCharacters.length < 2) {
        alert("Для сортировки нужно минимум 2 персонажа! Выберите больше игр или добавьте больше персонажей.");
        return;
    }
    
    // Инициализация результатов
    results = {};
    transitiveWeights = {};
    selectedCharacters.forEach(char1 => {
        results[char1.name] = { wins: 0, losses: 0, strength: 0 };
        transitiveWeights[char1.name] = {};
        selectedCharacters.forEach(char2 => {
            transitiveWeights[char1.name][char2.name] = 0;
        });
    });
    
    // Создаем все возможные пары для сравнения
    comparisons = [];
    for (let i = 0; i < selectedCharacters.length; i++) {
        for (let j = i + 1; j < selectedCharacters.length; j++) {
            comparisons.push([i, j]);
        }
    }
    
    shuffleArray(comparisons);
    
    // Сброс текущих персонажей
    currentLeftChar = null;
    currentRightChar = null;
    
    document.getElementById('sorter').style.display = 'block';
    document.getElementById('options').style.display = 'none';
    document.getElementById('results').style.display = 'none';
    
    showNextComparison();
}

function showNextComparison() {
    if (comparisons.length === 0) {
        finishSorting();
        return;
    }
    
    // Прогресс сортировки
    const totalComparisons = selectedCharacters.length * (selectedCharacters.length - 1) / 2;
    const progress = Math.round((totalComparisons - comparisons.length) / totalComparisons * 100);
    document.getElementById('progress').textContent = `${progress}%`;
    
    // Берем пару персонажей для сравнения
    const [index1, index2] = comparisons.pop();
    const char1 = selectedCharacters[index1];
    const char2 = selectedCharacters[index2];

    // Определяем, нужно ли менять позиции персонажей
    // Если один из текущих персонажей уже на экране, оставляем его на той же позиции
    let leftChar, rightChar, leftIndex, rightIndex;
    
    if (currentLeftChar && (char1.name === currentLeftChar || char2.name === currentLeftChar)) {
        // Персонаж слева остается
        if (char1.name === currentLeftChar) {
            leftChar = char1;
            leftIndex = index1;
            rightChar = char2;
            rightIndex = index2;
        } else {
            leftChar = char2;
            leftIndex = index2;
            rightChar = char1;
            rightIndex = index1;
        }
    } 
    else if (currentRightChar && (char1.name === currentRightChar || char2.name === currentRightChar)) {
        // Персонаж справа остается
        if (char1.name === currentRightChar) {
            rightChar = char1;
            rightIndex = index1;
            leftChar = char2;
            leftIndex = index2;
        } else {
            rightChar = char2;
            rightIndex = index2;
            leftChar = char1;
            leftIndex = index1;
        }
    } else {
        // Случайный выбор позиций (при первом сравнении или когда нет совпадений)
        if (Math.random() < 0.5) {
            leftChar = char1;
            leftIndex = index1;
            rightChar = char2;
            rightIndex = index2;
        } else {
            leftChar = char2;
            leftIndex = index2;
            rightChar = char1;
            rightIndex = index1;
        }
    }
    
    // Обновляем текущих персонажей
    currentLeftChar = leftChar.name;
    currentRightChar = rightChar.name;

    // Настройка первого персонажа (слева)
    const img1 = document.getElementById('img1');
    img1.src = leftChar.image;
    img1.alt = leftChar.name;
    img1.onerror = function() {
        this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300"><rect width="200" height="300" fill="lightgray"/><text x="100" y="150" font-family="Arial" font-size="16" text-anchor="middle" fill="black">' + leftChar.name + '</text></svg>';
        console.error("Не удалось загрузить изображение:", leftChar.image);
    };
    document.getElementById('name1').textContent = leftChar.name;
    
    // Настройка второго персонажа (справа)
    const img2 = document.getElementById('img2');
    img2.src = rightChar.image;
    img2.alt = rightChar.name;
    img2.onerror = function() {
        this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300"><rect width="200" height="300" fill="lightgray"/><text x="100" y="150" font-family="Arial" font-size="16" text-anchor="middle" fill="black">' + rightChar.name + '</text></svg>';
        console.error("Не удалось загрузить изображение:", rightChar.image);
    };
    document.getElementById('name2').textContent = rightChar.name;
    
    // Правильная привязка событий с двумя параметрами
    document.getElementById('char1').onclick = () => chooseCharacter(leftIndex, rightIndex);
    document.getElementById('char2').onclick = () => chooseCharacter(rightIndex, leftIndex);
}

function chooseCharacter(winnerIndex, loserIndex) {
    console.log("Выбран персонаж:", winnerIndex, "vs", loserIndex);
    const winner = selectedCharacters[winnerIndex].name;
    const loser = selectedCharacters[loserIndex].name;
    
    // Основное сравнение
    transitiveWeights[winner][loser] += 1;
    
    // Транзитивные сравнения
    selectedCharacters.forEach(char => {
        const middleChar = char.name;
        if (transitiveWeights[winner][middleChar] > 0 && transitiveWeights[middleChar][loser] > 0) {
            transitiveWeights[winner][loser] += 0.5;
        }
    });
    
    // Обновляем результаты
    results[winner].wins += 1;
    results[loser].losses += 1;
    results[winner].strength = Object.values(transitiveWeights[winner]).reduce((a, b) => a + b, 0);
    
    showNextComparison();
}

function finishSorting() {
    const sortedResults = selectedCharacters.map(char => ({
        name: char.name,
        image: char.image,
        score: results[char.name].strength
    })).sort((a, b) => b.score - a.score);
    
    // Очищаем результаты
    const resultsList = document.getElementById('results-list');
    resultsList.innerHTML = '';
    const podium = document.getElementById('podium');
    podium.innerHTML = '';
    
    // Отображаем топ-3 на подиуме
    const top3 = sortedResults.slice(0, 3);
    top3.forEach((char, index) => {
        const placeDiv = document.createElement('div');
        placeDiv.className = `podium-place ${index === 0 ? 'first-place' : index === 1 ? 'second-place' : 'third-place'}`;
        
        const img = document.createElement('img');
        img.src = char.image;
        img.className = 'podium-img';
        img.alt = char.name;
        img.onerror = function() {
            this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="200" viewBox="0 0 150 200"><rect width="150" height="200" fill="lightgray"/><text x="75" y="100" font-family="Arial" font-size="14" text-anchor="middle" fill="black">' + char.name + '</text></svg>';
        };
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'character-name';
        nameDiv.textContent = char.name;
        
        placeDiv.appendChild(img);
        placeDiv.appendChild(nameDiv);
        podium.appendChild(placeDiv);
    });
    
    // Отображаем остальные результаты в списке с правильной нумерацией
    sortedResults.slice(3).forEach((char, index) => {
        const li = document.createElement('li');
        li.textContent = char.name;
        li.setAttribute('data-position', index + 4); // Добавляем правильный номер
        resultsList.appendChild(li);
    });
    
    document.getElementById('sorter').style.display = 'none';
    document.getElementById('options').style.display = 'none';
    document.getElementById('results').style.display = 'block';
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}